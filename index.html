
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fire Weather — Six Counties (VA)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="mb-6 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Fire Weather Snapshot — VA Six Counties</h1>
        <p class="text-sm text-slate-600">Amelia, Nottoway, Dinwiddie, Prince George, Brunswick, Greensville</p>
      </div>
      <div class="text-right">
        <div id="lastRun" class="text-sm text-slate-600">Loading…</div>
        <button id="refreshBtn" class="mt-2 inline-flex items-center rounded-2xl bg-indigo-600 text-white px-3 py-1.5 shadow hover:bg-indigo-700">Refresh</button>
      </div>
    </header>

    <section id="banner" class="hidden mb-4 rounded-xl border border-amber-300 bg-amber-50 text-amber-900 p-3">
      <strong>Partial data:</strong> One or more sources failed. Displaying what we could fetch.
    </section>

    <div class="mb-4 flex items-center gap-2">
      <label class="text-sm text-slate-700">FIRMS MAP_KEY (optional, visible in client):</label>
      <input id="firmsKey" type="password" placeholder="paste key" class="w-64 rounded-md border border-slate-300 px-2 py-1 text-sm" />
      <button id="firmsApply" class="text-sm rounded-md border border-slate-300 px-2 py-1 hover:bg-slate-100">Use</button>
      <span class="text-xs text-slate-500">If omitted, hotspot counts are skipped.</span>
    </div>

    <div class="overflow-x-auto rounded-2xl shadow bg-white">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-100 text-slate-700">
          <tr>
            <th class="p-3 text-left">County</th>
            <th class="p-3 num">Min RH (next 24h)</th>
            <th class="p-3 num">Max Wind mph (next 24h)</th>
            <th class="p-3 num">Temp °F (peak)</th>
            <th class="p-3 num">Hotspots (24h, ±0.25°)</th>
            <th class="p-3 text-left">Risk</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="mt-3 text-xs text-slate-500">
      Risk = <code>30/30/30</code> crossover heuristic: <em>Min RH ≤ 30%</em> and <em>Max Sustained/Gust ≥ 30 mph</em> and <em>Peak Temp ≥ 86°F</em>. If all three conditions are met → <span class="font-semibold">EXTREME</span>.
      If two are met → <span class="font-semibold">HIGH</span>. If one → <span class="font-semibold">ELEV</span>. Otherwise <span class="font-semibold">MOD</span>.
    </p>

  </div>

  <script>
    // --- Configuration ------------------------------------------------------
    const counties = [
      // Rough centroids; tweak if desired
      { name: "Amelia",         lat: 37.340, lon: -77.977 },
      { name: "Nottoway",       lat: 37.142, lon: -78.051 },
      { name: "Dinwiddie",      lat: 37.078, lon: -77.612 },
      { name: "Prince George",  lat: 37.220, lon: -77.288 },
      { name: "Brunswick",      lat: 36.757, lon: -77.888 },
      { name: "Greensville",    lat: 36.693, lon: -77.540 },
    ];
    const bboxDelta = 0.25; // ±0.25° for FIRMS

    const el = (id) => document.getElementById(id);

    const fmtNum = (v, unit="") => (v===null||v===undefined||Number.isNaN(v)) ? "—" : `${Math.round(v)}${unit}`;

    function badge(text, level) {
      const cls = {
        EXTREME: "bg-red-600/10 text-red-700 ring-1 ring-red-600/20",
        HIGH:    "bg-orange-500/10 text-orange-700 ring-1 ring-orange-500/20",
        ELEV:    "bg-amber-400/10 text-amber-700 ring-1 ring-amber-400/20",
        MOD:     "bg-emerald-500/10 text-emerald-700 ring-1 ring-emerald-500/20",
      }[level] || "bg-slate-300 text-slate-700";
      return `<span class="badge ${cls}">${text}</span>`;
    }

    function classify(minRH, maxWind, peakT) {
      const c1 = (minRH !== null && minRH <= 30);
      const c2 = (maxWind !== null && maxWind >= 30);
      const c3 = (peakT !== null && peakT >= 86);
      const total = [c1,c2,c3].filter(Boolean).length;
      if (total === 3) return {label: "EXTREME", score: 3};
      if (total === 2) return {label: "HIGH", score: 2};
      if (total === 1) return {label: "ELEV", score: 1};
      return {label: "MOD", score: 0};
    }

    function mphFromWindStr(str) {
      if (!str) return null; // e.g., "15 mph" or "5 to 10 mph"
      const nums = (str.match(/\d+/g) || []).map(n => parseInt(n,10));
      if (!nums.length) return null;
      // If a range like "5 to 10 mph", take the higher value
      return Math.max(...nums);
    }

    async function fetchJson(url, tries=2) {
      for (let i=0; i<tries; i++) {
        try {
          const r = await fetch(url, {headers: {"Accept": "application/ld+json, application/json"}});
          if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          return await r.json();
        } catch (e) {
          if (i === tries-1) throw e; // rethrow on final attempt
          await new Promise(res => setTimeout(res, 500));
        }
      }
    }

    async function getHourly(lat, lon) {
      const p = await fetchJson(`https://api.weather.gov/points/${lat},${lon}`);
      const hourlyUrl = p?.properties?.forecastHourly;
      if (!hourlyUrl) throw new Error("No hourly forecast URL");
      const h = await fetchJson(hourlyUrl);
      return h?.properties?.periods || [];
    }

    function summarize24h(periods) {
      const now = new Date();
      const cutoff = new Date(now.getTime() + 24*3600*1000);
      const next24 = periods.filter(x => new Date(x.startTime) < cutoff);
      if (!next24.length) return { minRH: null, maxWind: null, peakT: null };
      let minRH = null, maxWind = null, peakT = null;
      for (const p of next24) {
        const rh = p.relativeHumidity?.value; // %
        const wind = mphFromWindStr(p.windSpeed) || mphFromWindStr(p.windGust);
        const t = p.temperature;
        if (typeof rh === 'number') minRH = (minRH===null)? rh : Math.min(minRH, rh);
        if (typeof wind === 'number') maxWind = (maxWind===null)? wind : Math.max(maxWind, wind);
        if (typeof t === 'number') peakT = (peakT===null)? t : Math.max(peakT, t);
      }
      return { minRH, maxWind, peakT };
    }

    async function getFirmsCount(lat, lon, key) {
      if (!key) return null; // optional
      // VIIRS 24h around bbox; public endpoint pattern (key exposed in client)
      const minLon = lon - bboxDelta, maxLon = lon + bboxDelta;
      const minLat = lat - bboxDelta, maxLat = lat + bboxDelta;
      const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${encodeURIComponent(key)}/VIIRS_SNPP_NRT/24h/${minLat},${minLon},${maxLat},${maxLon}`;
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("FIRMS error");
        const text = await r.text();
        // Count lines minus header (if any)
        const lines = text.trim().split(/\r?\n/);
        // Heuristic: if first line contains 'latitude', treat as header
        const hasHeader = /latitude/i.test(lines[0]);
        return hasHeader ? Math.max(0, lines.length - 1) : lines.length;
      } catch (e) {
        return null; // fail soft
      }
    }

    async function build() {
      const tbody = el('tbody');
      tbody.innerHTML = '';
      el('banner').classList.add('hidden');
      const failures = [];
      const key = el('firmsKey').value.trim() || null;

      const rows = [];
      for (const c of counties) {
        try {
          const periods = await getHourly(c.lat, c.lon);
          const {minRH, maxWind, peakT} = summarize24h(periods);
          const hotspots = await getFirmsCount(c.lat, c.lon, key);
          const cls = classify(minRH, maxWind, peakT);
          rows.push({ county: c.name, minRH, maxWind, peakT, hotspots, cls });
        } catch (e) {
          failures.push(c.name);
          rows.push({ county: c.name, minRH: null, maxWind: null, peakT: null, hotspots: null, cls: {label: 'MOD', score: 0} });
        }
      }

      // Sort by risk desc, then name
      rows.sort((a,b)=> (b.cls.score - a.cls.score) || a.county.localeCompare(b.county));

      // Render
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `
          <td class="p-3 font-medium">${r.county}</td>
          <td class="p-3 num">${fmtNum(r.minRH, '%')}</td>
          <td class="p-3 num">${fmtNum(r.maxWind)}</td>
          <td class="p-3 num">${fmtNum(r.peakT)}</td>
          <td class="p-3 num">${r.hotspots===null? '—' : r.hotspots}</td>
          <td class="p-3">${badge(r.cls.label, r.cls.label)}</td>`;
        tbody.appendChild(tr);
      }

      if (failures.length) {
        el('banner').classList.remove('hidden');
      }

      // Timestamp in ET (America/New_York)
      const now = new Date();
      const ts = now.toLocaleString('en-US', { timeZone: 'America/New_York', hour12: true });
      el('lastRun').textContent = `Updated: ${ts} ET`;
    }

    el('refreshBtn').addEventListener('click', build);
    el('firmsApply').addEventListener('click', build);

    // First load
    build();
  </script>
</body>
</html>
